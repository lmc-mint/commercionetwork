(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{325:function(t,s,a){t.exports=a.p+"assets/img/kms_validator_schema.a6304b37.png"},494:function(t,s,a){"use strict";a.r(s);var e=a(14),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"kms-with-yubihsm2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kms-with-yubihsm2"}},[t._v("#")]),t._v(" KMS with YubiHSM2")]),t._v(" "),s("h2",{attrs:{id:"general-concepts"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#general-concepts"}},[t._v("#")]),t._v(" General concepts")]),t._v(" "),s("h2",{attrs:{id:"hardware-requirements"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#hardware-requirements"}},[t._v("#")]),t._v(" Hardware requirements")]),t._v(" "),s("ul",[s("li",[t._v("SO: Ubuntu 18.04 (64-bit) or later  (preferably LTS version)")]),t._v(" "),s("li",[t._v("Minimum amount of RAM: 4Gb")]),t._v(" "),s("li",[t._v("Available disk space: 100 Gb")]),t._v(" "),s("li",[t._v("Connect to the your validator node in private network (LAN or VPN)")])]),t._v(" "),s("h2",{attrs:{id:"scenario"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scenario"}},[t._v("#")]),t._v(" Scenario")]),t._v(" "),s("p",[s("img",{attrs:{src:a(325),alt:"Kms Validator connection"}})]),t._v(" "),s("p",[t._v("For simplicity in the explanation we can assume that we have a vpn that connects the Data Center with the Cloud with the ip class")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("KMS")]),t._v(": "),s("code",[t._v("10.1.1.1")])]),t._v(" "),s("li",[s("strong",[t._v("Validator node")]),t._v(": "),s("code",[t._v("10.1.1.254")])])]),t._v(" "),s("p",[t._v("The protection is at the port opening level and it's the following")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("KMS")]),t._v(": no open ports, only access to the lan or vpn towards the Validator node")]),t._v(" "),s("li",[s("strong",[t._v("Validator node")]),t._v(":\n"),s("ul",[s("li",[t._v("port "),s("code",[t._v("26656")]),t._v(" open on all ip")]),t._v(" "),s("li",[t._v("port "),s("code",[t._v("26658")]),t._v(" open on all ip but with access limited to the KMS")])])])]),t._v(" "),s("h2",{attrs:{id:"installation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#installation"}},[t._v("#")]),t._v(" Installation")]),t._v(" "),s("p",[t._v("Upgrade your ubuntu system")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("su")]),t._v(" -\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" update\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" upgrade "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v("\n")])])]),s("p",[t._v("Create a new user to run the KMS server and reboot the system")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /data_tmkms\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useradd")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-m")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" /data_tmkms/tmkms "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-G")]),t._v(" tmkms "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" /bin/bash\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'SUBSYSTEMS=="usb", ATTRS{product}=="YubiHSM", GROUP=="tmkms"\'')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" /etc/udev/rules.d/10-yubihsm.rules\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reboot")]),t._v("\n")])])]),s("p",[s("strong",[t._v("Please note")]),t._v(": it might be necessary to restart the server several times to apply the rules")]),t._v(" "),s("p",[t._v("Install the components")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("su")]),t._v(" -\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" gcc "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" libusb-1.0-0-dev pkg-config "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v("\n")])])]),s("p",[t._v("Install rust: language for compiling TmKms")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("su")]),t._v(" - tmkms\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--proto")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'=https'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--tlsv1.2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-sSf")]),t._v(" https://sh.rustup.rs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.cargo/env\n\n")])])]),s("p",[t._v("Install TmKms")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/tendermint/kms.git\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/kms\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cargo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" tmkms "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--features")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("yubihsm "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--locked")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--force")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--version")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.10")]),t._v(".0\n")])])]),s("p",[t._v("Check the installation version")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("tmkms version\n")])])]),s("h3",{attrs:{id:"yubihsm2-service-installation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#yubihsm2-service-installation"}},[t._v("#")]),t._v(" YubiHSM2 Service Installation")]),t._v(" "),s("p",[t._v("The YubiHSM2 is a hardware device that must be connected to the server via USB. It is also necessary to install additional tools of the yubihsm in order to manage the connection as a service and not directly on usb.")]),t._v(" "),s("p",[t._v("Install yubico utilities. Search in "),s("a",{attrs:{href:"https://developers.yubico.com/YubiHSM2/Releases/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://developers.yubico.com/YubiHSM2/Releases/"),s("OutboundLink")],1),t._v(" the right version for your system")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("su")]),t._v(" -\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /tmp\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("VERSION")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"yubihsm2-sdk-2019-12-ubuntu1804-amd64.tar.gz"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://developers.yubico.com/YubiHSM2/Releases/'),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v('"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" zxf "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" ./yubihsm2-sdk/*.deb\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-rf")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v("\n")])])]),s("p",[t._v("Activate the service")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tee")]),t._v(" /etc/systemd/system/yubihsm-connector.service "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /dev/null "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF \n[Unit]\nDescription=YubiHSM connector\nDocumentation=https://developers.yubico.com/YubiHSM2/Component_Reference/yubihsm-connector/\nAfter=network-online.target\nWants=network-online.target systemd-networkd-wait-online.service\n\n[Service]\nRestart=on-abnormal\nUser=tmkms\nGroup=tmkms\nExecStart=/usr/bin/yubihsm-connector -c /etc/yubihsm-connector.yaml\nPrivateTmp=true\nProtectHome=true\nProtectSystem=full\n\n[Install]\nWantedBy=multi-user.target\nEOF")]),t._v("\n\nsystemctl "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" yubihsm-connector.service\nsystemctl start yubihsm-connector.service\n")])])]),s("p",[t._v("Check the service status and the listening port")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("systemctl status yubihsm-connector.service\nss "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-tlpn")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12345")]),t._v("\n")])])]),s("h3",{attrs:{id:"hsm-installation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#hsm-installation"}},[t._v("#")]),t._v(" HSM Installation")]),t._v(" "),s("p",[t._v("Insert yubiHSM 2 into the usb slot. If the device has been used previously, reset it by holding down the metal ring for more than 3 seconds when the device is inserted.")]),t._v(" "),s("p",[t._v("You need to create a configuration file tmkms.toml containing the information of the validator node to which the Kms must connect.")]),t._v(" "),s("p",[t._v("You can find an example file below."),s("br"),t._v("\nCreate the folder for the configuration")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/kms/commercio\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/kms/commercio/tmkms.toml\n\n")])])]),s("p",[t._v("When using the "),s("code",[t._v("tmkms")]),t._v(" user, the value of the "),s("code",[t._v("$HOME")]),t._v(" variable is "),s("code",[t._v("/data_tmkms/tmkms")]),t._v(".")]),t._v(" "),s("div",{staticClass:"language-toml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-toml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("chain")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("id")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"commercio-3"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("key_format")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("type")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bech32"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("account_key_prefix")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"did:com:"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("consensus_key_prefix")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"did:com:valconspub"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("state_file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/data_tmkms/tmkms/kms/commercio/commercio_priv_validator_state.json"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("validator")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("addr")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tcp://10.1.1.254:26658"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The ip of Validator Node")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("chain_id")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"commercio-3"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("reconnect")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# true is the default")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("secret_key")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/data_tmkms/tmkms/kms/commercio/secret_connection.key"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("providers.yubihsm")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("adapter")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("type")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("addr")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tcp://127.0.0.1:12345"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("auth")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("key")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("password_file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/data_tmkms/tmkms/kms/password"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# It is possible to enter the password directly using the password parameter instead of password_file")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("keys")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("chain_ids")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"commercio-3"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("key")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("serial_number")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9876543210"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# identify serial number of a specific YubiHSM to connect to")]),t._v("\n")])])]),s("p",[t._v("For the creation of the file you need to have the following data")]),t._v(" "),s("ul",[s("li",[t._v("Chain-id is the identifier of the chain for which the node is being configured. In the case of mainnet it is "),s("code",[t._v("commercio-3")])]),t._v(" "),s("li",[t._v("Prefix of public addresses of the chain: in the case of commercio it is "),s("code",[t._v("did:com:")])]),t._v(" "),s("li",[t._v("Prefix of the public addresses of the nodes: in the case of commercio it is "),s("code",[t._v("did:com:valconspub")])]),t._v(" "),s("li",[t._v("Address within the lan or vpn of the validator node: for simplicity we have assumed to have the address "),s("code",[t._v("10.1.1.254")])]),t._v(" "),s("li",[t._v("The password of our HSM device: initially the password is "),s("strong",[t._v('"password"')])]),t._v(" "),s("li",[t._v("The id of the key to use of the HSM: for the single configuration is "),s("code",[t._v("1")])]),t._v(" "),s("li",[t._v("The serial Number of our device: generally it is what is indicated on the label of the YubiHSM2. They must be 10 digits. For the missing digits add zeros at the beginning")])]),t._v(" "),s("p",[t._v("Create the file "),s("code",[t._v("/data_tmkms/tmkms/kms/password")]),t._v(' and enter the password "password" inside it')]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("printf")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"password"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /data_tmkms/tmkms/kms/password\n")])])]),s("h4",{attrs:{id:"hsm-reset"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#hsm-reset"}},[t._v("#")]),t._v(" HSM Reset")]),t._v(" "),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[t._v("DANGER")]),t._v(" "),s("p",[t._v("⚠️ This procedure will do a complete reset of the device. It must not be done for a possible second installation of another node that uses the same hsm")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("tmkms yubihsm setup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" /data_tmkms/tmkms/kms/commercio/tmkms.toml\n")])])]),s("p",[t._v("An output of this type should appear")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("This process will *ERASE* the configured YubiHSM2 and reinitialize it:\n\n- YubiHSM serial: 9876543210\n\nAuthentication keys with the following IDs and passwords will be created:\n\n- key 0x0001: admin:\n\n    double section release consider diet pilot flip shell mother alone what fantasy\n    much answer lottery crew nut reopen stereo square popular addict just animal\n\n- authkey 0x0002 [operator]:  kms-operator-password-1k02vtxh4ggxct5tngncc33rk9yy5yjhk\n- authkey 0x0003 [auditor]:   kms-auditor-password-1s0ynq69ezavnqgq84p0rkhxvkqm54ks9\n- authkey 0x0004 [validator]: kms-validator-password-1x4anf3n8vqkzm0klrwljhcx72sankcw0\n- wrapkey 0x0001 [primary]:   21a6ca8cfd5dbe9c26320b5c4935ff1e63b9ab54e2dfe24f66677aba8852be13\n\n*** Are you SURE you want erase and reinitialize this HSM? (y/N): y\n21:08:09 [WARN] factory resetting HSM device! all data will be lost!\n\n21:08:11 [WARN] deleting temporary setup authentication key from slot 65534\n     Success reinitialized YubiHSM (serial: 9876543210)\n")])])]),s("p",[t._v("Confirm when asked to reinitialize the device (in bold in the output). Take note of the output, especially the 24 words provided as a new password (also in bold in the output above).\nSave the new password of the file")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("printf")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"double section release consider diet pilot flip shell mother alone what fantasy much answer lottery crew nut reopen stereo square popular addict just animal"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("/data_tmkms/tmkms/kms/password\n")])])]),s("p",[s("strong",[t._v("NB")]),t._v(": The password is provided on two separate lines but must be set in the file on a single line")]),t._v(" "),s("h3",{attrs:{id:"key-generation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#key-generation"}},[t._v("#")]),t._v(" Key generation")]),t._v(" "),s("p",[t._v("The keys are generated using the tmkms command. The command is structured as follows")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("tmkms yubihsm keys generate "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-b")]),t._v(" steakz4u-validator-key.enc "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" /data_tmkms/tmkms/kms/commercio/tmkms.toml\n")])])]),s("p",[t._v("Launch the command to produce the new key. The "),s("code",[t._v("-b")]),t._v(" option allows you to save the key")]),t._v(" "),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[t._v("DANGER")]),t._v(" "),s("p",[t._v("⚠️ The steakz4u-validator-key.enc backup file must be immediately transferred to the multiple off-line supports and secured. If it is lost, the key generated at this time can no longer be replicated.")])]),t._v(" "),s("p",[t._v("In the case of a new installation of the node, the key must be imported into the HSM. To do this, use the following command")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("tmkms yubihsm keys "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v(" json "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-i")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" priv_validator.json "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" /data_tmkms/tmkms/kms/commercio/tmkms.toml\n")])])]),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[t._v("DANGER")]),t._v(" "),s("p",[t._v("⚠️ The priv_validator.json backup file must be immediately transferred to the multiple, off-line, encrypted and secured supports. If it is lost, the key generated at this time can no longer be replicated.")])]),t._v(" "),s("h3",{attrs:{id:"key-confirmation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#key-confirmation"}},[t._v("#")]),t._v(" Key confirmation")]),t._v(" "),s("p",[t._v("To confirm that the keys are present and configured in the HSM use the command")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("tmkms yubihsm keys list  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" /data_tmkms/tmkms/kms/commercio/tmkms.toml\n")])])]),s("p",[t._v("Should be presented an output like the following")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Listing keys in YubiHSM #9876543210:\n- 0x0001: did:com:valconspub1zcjduepq592mn6xucyqvfrvjegruhnx55cruffkrfq0rryu809fzkgwg684qmetxxs\n")])])]),s("p",[s("code",[t._v("did:com:valconspub1zcjduepq592mn6xucyqvfrvjegruhnx55cruffkrfq0rryu809fzkgwg684qmetxxs")]),t._v(" is the public key of the validator node. This key will be needed to perform the validator node creation transaction")]),t._v(" "),s("p",[t._v("At this point the KMS can be connected to the Node")]),t._v(" "),s("p",[t._v("Test the KMS service")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("tmkms start "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" /data_tmkms/tmkms/kms/commercio/tmkms.toml\n")])])]),s("p",[t._v("An output like this should appear.")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Mar 05 12:20:26.781  INFO tmkms::commands::start: tmkms 0.10.0 starting up…\nMar 05 12:20:27.280  INFO tmkms::keyring: [keyring:yubihsm] added consensus key did:com:valconspub1zcjduepq592mn6xucyqvfrvjegruhnx55cruffkrfq0rryu809fzkgwg684qmetxxs\nMar 05 12:20:27.280  INFO tmkms::connection::tcp: KMS node ID: 4248B5C7755600D694C47ECEA710A2DAB743AA38\nMar 05 12:20:58.682 ERROR tmkms::client: [commercio-3@tcp://10.1.1.254:26658] I/O error: Connection timed out (os error 110)\nMar 05 12:20:59.683  INFO tmkms::connection::tcp: KMS node ID: 4248B5C7755600D694C47ECEA710A2DAB743AA38\n...\n")])])]),s("p",[t._v("If the output reports errors other than simple connection failure then the installation should be checked.\n"),s("strong",[t._v("Please note")]),t._v(": The connection attempt fails because we have not yet configured the node to which the kms should connect.\ncrtl+c to abort the process.")]),t._v(" "),s("h3",{attrs:{id:"config-the-service"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#config-the-service"}},[t._v("#")]),t._v(" Config the service")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tee")]),t._v(" /etc/systemd/system/tmkms.service "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /dev/null "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF \n[Unit]\nDescription=Commercio tmkms\nAfter=network.target\n\n[Service]\nUser=tmkms\nWorkingDirectory=/data_tmkms/tmkms/.cargo/bin\nExecStart=/data_tmkms/tmkms/.cargo/bin/tmkms start -c /data_tmkms/tmkms/kms/commercio/tmkms.toml\nRestart=always\nStandardOutput=syslog\nStandardError=syslog\nSyslogIdentifier=tmkms\nRestartSec=3\nLimitNOFILE=4096\n\n[Install]\nWantedBy=multi-user.target\nEOF")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" tmkms\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl start tmkms\n")])])]),s("h3",{attrs:{id:"config-the-validator-node"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#config-the-validator-node"}},[t._v("#")]),t._v(" Config the validator node")]),t._v(" "),s("p",[t._v("To allow the validator node to access the private key, the "),s("code",[t._v(".commercionetworkd/config/config.toml")]),t._v(" file must be modified.\nEdit the parameter by putting the ip of the validator node")]),t._v(" "),s("div",{staticClass:"language-toml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-toml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("priv_validator_laddr")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tcp://10.1.1.254:26658"')]),t._v("\n")])])]),s("p",[t._v("Restart the service of the node")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("systemctl restart commercionetworkd\n")])])]),s("p",[t._v("Check the output of the kms. Logs should vary in this way")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("Jan "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(" 09:23:14.389  INFO tmkms::session: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("commercio-3@tcp://10.1.1.254:26658"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" connected to validator successfully\nJan "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(" 09:23:14.389  WARN tmkms::session: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("commercio-3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" tcp:/10.1.1.254:26658: unverified validator peer ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("A312D8F64C9FC71A1A947C377F64B7302C951361"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);